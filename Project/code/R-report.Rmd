---
title: "**STA2201 Project**"
author: "Quynh Vu"
date: "April 19, 2023"
bibliography: bibliography.bib
output: 
  pdf_document:
    toc: true
    toc_depth: 2
abstract: "The unprecedented emergence of COVID-19 upended our lives to a great extent, resulting in pressing health crises and economic fallouts on a global scale. There have been, by and large, appreciable variations in the course of the COVID-19 outbreak across countries and territories. To come within the scope of this study, we combined resident-level COVID-19 fatalities data in Toronto, the 2016 census demographics data and the community council data to quantify the differentials in the extent to which residents in four Toronto communities (Etobicoke York, North York, Toronto and East York, and Scarborough) are susceptible to COVID-19 during the early phase of the pandemic. We modelled the probability that individuals in different age groups would pass on after contracting COVID-19 in 2020 by the Hierarchical Logit Model. The findings are that these probabilities differ across four communities, which is attributable to varied capacities and unequal access to hospitals among neighbourhoods to a certain degree. Our aim is to provide data-based guidance for further research in public health policies to reduce health inequities."
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = FALSE, 
  out.width = "100%",
  fig.width = 10,
  fig.height = 6.7, 
  fig.retina = 3,
  cache = TRUE)
```

```{r echo=FALSE}
library(tinytex)
library(tidyverse)
library(here)
library(rstan)
library(bayesplot) 
library(loo) 
library(tidybayes) 
library(reshape2)
library(lubridate)
library(gridExtra)
library(rvest)
library(janitor)
library(anytime) 
library(zoo)
library(Hmisc)
library(forecast)
library(ggpubr)
library(viridis) 
library(stringr)  
library(rvest)
library(skimr)
library(visdat)
```

\newpage 

# 1. Introduction

COVID-19 is a contagious disease that results from the novel strain of the SARS-CoV-2 virus. The first interhuman transmission case was confirmed in Toronto (Ontario) on January 25, 2020 [@urrutia2021overview], shortly followed by widespread disruption to businesses, education, and essential health services across Canada. The Canadian government gave priority to the procurement and distribution of effective COVID vaccines to lift restrictions on our regular physical activities and stabilize outbreak incidence above all things. However, three years of the pandemic accentuated the inadequacy of hospital capacity and shortage of healthcare workers to serve individuals with medical needs, evidenced by an increase in physician office visits by 27% for the first twelve months of the pandemic [@chang2022health]. It poses a challenge to Canada's self-sufficiency and the ability to mitigate future outbreaks and curtail fatalities. It is noteworthy that "the concentration of poverty in particular neighbourhoods" [@hulchanski2010three] resulting from income polarization in Toronto renders residents living in low-income neighbourhoods subject to poorer healthcare infrastructure and, therefore, more vulnerable to the pandemic than their counterparts. Estimating the individual mortality risk of COVID-19 (i.e. how likely a person is to die when infected with the disease) can help nip future outbreaks in the bud by guiding policymakers to implement public services and develop infrastructure that addresses those who are most in need. In this study, we examine the extent to which how mortality risk from COVID-19 varies across four communities in Toronto after controlling for community-level population size and age structure, sex at birth, and healthcare services.

# 2. Data

## a) Data Sources and Cleaning

We combined 3 data sets for the analysis as follows:

  * For the COVID-19 mortalities in Toronto data set, we sourced data from [Open data Toronto](https://open.toronto.ca/dataset/covid-19-cases-in-toronto/), which is now hosted on GitHub ([access here](https://github.com/pquynhvu/STA2201-W2023/blob/main/Project/data/COVID19%20cases.csv)). This individual snapshot of mortality risk includes the patient's age and gender, neighbourhoods characterized by the Forward Sortation Area (FSA) code, date reported, whether hospitalized or not, and outcome (resolved or fatal). We want to note that a "fatal" outcome implies any case that has died and the medical cause of death is related to COVID-19, while a "resolved" outcome means any case that has either recovered or died but the medical cause of death is unrelated to COVID-19.

  * For the Canadian 2016 neighbourhood-level census demographics, we also sourced data from [Open data Toronto](https://open.toronto.ca/dataset/wellbeing-toronto-demographics/), which is also hosted on GitHub ([access here](https://github.com/pquynhvu/STA2201-W2023/blob/main/Project/data/wellbeing2016.csv)). The data set was aggregated from the total population in the 2016 Census by Statistics Canada and Toronto's 140 neighbourhood planning areas by the City of Toronto. For the 2016 census, the undercoverage rate published by Statistics Canada was 4.32% [@StatsCAN], which is the missed rate in the census due to travelling, refusal to participate, the growing number of immigrants and non-permanent residents in Canada, etc. 

  * For the community council data, we scraped data from the [City of Toronto website](https://www.toronto.ca/city-government/data-research-maps/neighbourhoods-communities/community-council-area-profiles/) using the `rvest` package to categorize Toronto's neighbourhoods into the designated communities. We also scraped the list of hospitals in Toronto by neighbourhoods from [Wikipedia](https://en.wikipedia.org/wiki/List_of_hospitals_in_Toronto).
  
We obtained resident-level fatalities data in Toronto from 2020 to 2023. To study how the mortality risks from COVID-19 varied across communities in Toronto before pharmaceutical public health interventions were introduced, we primarily used resident-level fatalities data before December 15, 2020 [@StatsCAN], when Ontario started its first phase of vaccine rollouts. We first matched the resident-level fatalities data with the list of hospitals in Toronto and categorized neighbourhoods into four designated communities by the FSA code. We created a numeric variable for the number of hospitals in the community (`num_of_hospitals`). We then aggregated this data set with the population data by matching the neighbourhood of residence and age group of each individual. To merge these two data sets, we corrected the difference in some neighbourhoods' recorded names (e.g. \textit{Danforth East York} to \textit{Danforth-East York} or \textit{Briar Hill-Belgravia} to \textit{Briar Hill - Belgravia}). We created three numeric variables, the proportion of the population aged above 70 in a community (`prop70plus`), the total population in each community (`pop_district`), and the average number of residents that a hospital in a particular neighbourhood should be able to serve at its maximum capacity, assuming that residents do not visit a hospital outside their community of residence (`pop_per_hospital`). Also, since there is mounting evidence that a biological male suffers more severe COVID-19 symptoms and has a higher mortality risk compared to a biological female [@scully2020considering], we only included individuals with clearly identified sex at birth in the analysis (i.e. we considered a transwoman a biological male and a transman a biological female and excluded patients who declared themselves to be non-binary, transgender, and other) to investigate these sex differences in the immune response against coronavirus within the Toronto population. The "cleaned" data set available to run analyses has no missing values.

```{r echo=FALSE}
covid_df <- read.csv("https://raw.githubusercontent.com/pquynhvu/STA2201-W2023/main/Project/data/COVID19%20cases.csv") |>           
            select(Age.Group, Neighbourhood.Name, FSA, Reported.Date, Client.Gender, Outcome, Ever.Hospitalized) |>
            rename(age_gp = Age.Group, 
                   NBHD = Neighbourhood.Name,
                   reported_date = Reported.Date,
                   gender = Client.Gender,
                   hospitalized = Ever.Hospitalized,
                   outcome = Outcome) |>
           filter(outcome != "ACTIVE") |>
           mutate_if(is.character, ~na_if(., '')) 
```

```{r echo=FALSE}
covid_df <- covid_df |> filter(gender %in% c("FEMALE", "MALE", "TRANS WOMAN", "TRANS MAN")) |>
                        mutate(reported_date = as.Date(reported_date, "%m/%d/%Y"),
                               year = year(reported_date),
                               age_gp = case_when(age_gp == "50 to 59 Years" ~ '50-59',
                                                  age_gp == "20 to 29 Years" ~ '20-29',
                                                  age_gp == "60 to 69 Years" ~ '60-69',
                                                  age_gp == "80 to 89 Years" ~ '80-89',
                                                  age_gp == "70 to 79 Years" ~ '70-79',
                                                  age_gp == "30 to 39 Years" ~ '30-39',
                                                  age_gp == "40 to 49 Years" ~ '40-49',
                                                  age_gp == "19 and younger" ~ '19-',
                                                  age_gp == "90 and older" ~ '90+'),
                               age_fc = case_when(age_gp == "19-" ~ 1, age_gp == "20-29" ~ 2, age_gp == "30-39" ~ 3, 
                                                  age_gp == "40-49" ~ 4, age_gp == "50-59" ~ 5, age_gp == "60-69" ~ 6, 
                                                  age_gp == "70-79" ~ 7, age_gp == "80-89" ~ 8, age_gp == "90+" ~ 9),
                               gender_fc = case_when(gender == "FEMALE" ~ 1, gender == "MALE" ~ 0, 
                                                     gender == "TRANS WOMAN" ~ 0, gender == "TRANS MAN" ~ 1),
                               outcome = as.factor(recode(outcome, `1` = "FATAL", `0` = "RESOLVED")),
                               deaths = case_when(outcome == "FATAL" ~ 1, outcome == "RESOLVED" ~ 0)) |>
                       drop_na()
```

```{r echo=FALSE}
district_page <- read_html('https://www.zipcode.com.ng/2023/01/city-of-toronto-on.html')
district <- district_page |> html_nodes("td:nth-child(1)") |> html_text()
FSA2d <- district_page |> html_nodes("tr:nth-child(7) td:nth-child(2) , .table-responsive tr:nth-child(2) td:nth-child(2)") |> html_text()
district2d <- district_page |> html_nodes("tr:nth-child(7) td:nth-child(1) , tr:nth-child(2) td:nth-child(1)") |> html_text()
postalcode2 <- data.frame(district = district2d, FSA = FSA2d) |>
               mutate(FSA = strsplit(as.character(FSA), ",")) |> 
               unnest(FSA) |>
               mutate(district = case_when(district == "East York" ~ "Toronto and East York",
                                           district == "York" ~ "Toronto and East York"))
postalcode2$FSA <- gsub(" ","",as.character(postalcode2$FSA))
                         
FSA_page <- read_html('https://www.zipdatamaps.com/en/postal-code-lists/canada/list-of-all-forward-sortation-areas-in-ontario')
FSA <- FSA_page |> html_nodes(".table-condensed a") |> html_text()
district_of_FSA <- FSA_page |> html_nodes("td+ td") |> html_text()
postalcode1 <- data.frame(district_of_FSA, FSA) 
postalcode1$district_of_FSA <- gsub("Old ","",as.character(postalcode1$district_of_FSA))
postalcode1 <- postalcode1 |> filter(district_of_FSA %in% district) |>
               rename(district = "district_of_FSA") |>
               mutate(district = case_when(district == "Scarborough" ~ "Scarborough",
                                           district == "North York" ~ "North York",
                                           district == "Toronto" ~ "Toronto and East York",
                                           district == "York" ~ "Toronto and East York",
                                           district == "Etobicoke" ~ "Etobicoke York"))

postalcode <- rbind(postalcode1, postalcode2) |> as.data.frame() |> distinct() 
ix <- which(postalcode$district == "North York" & postalcode$FSA %in% c("M3C", "M4A", "M4G", "M4P"))
postalcode <- postalcode |> slice(- ix)

hospital_page <- read_html('https://en.wikipedia.org/wiki/List_of_hospitals_in_Toronto')
hospitals <- hospital_page |> html_nodes("td:nth-child(1)") |> html_text() |> as.data.frame() |> slice_head(n = 35)
hospital_district <- hospital_page |> html_nodes("td:nth-child(3)") |> html_text()
hospitals <- data.frame(hospitals, hospital_district) |>
             rename(hospital = "html_text.html_nodes.hospital_page...td.nth.child.1....", district = "hospital_district") |>
             mutate(district = case_when(district == "Scarborough" ~ "Scarborough",
                                         district == "North York" ~ "North York",
                                         district == "Old Toronto" ~ "Toronto and East York",
                                         district == "East York" ~ "Toronto and East York",
                                         district == "York" ~ "Toronto and East York",
                                         district == "Etobicoke" ~ "Etobicoke York")) |>
             group_by(district) |>
             mutate(num_of_hospitals = n()) |>
             ungroup()
hospitals_by_FSA <- left_join(hospitals, postalcode, by = c("district")) |> select(- hospital) |> distinct()
```

```{r echo=FALSE}
covid_df <- left_join(covid_df, hospitals_by_FSA, by = "FSA") |> distinct() |>
            mutate(district_fc = case_when(district == "North York" ~ 1,
                                           district == "Toronto and East York" ~ 2,
                                           district == "Scarborough" ~ 3,
                                           district == "Etobicoke York" ~ 4),
                   hospitalized_fc = case_when(hospitalized == "Yes" ~ 1, hospitalized == "No" ~ 0),) 
```

```{r echo=FALSE}
age70plus <- c('70-79', '80-89', '80-89', '90+')
pop_df <- read.csv("https://raw.githubusercontent.com/pquynhvu/STA2201-W2023/main/Project/data/wellbeing2016.csv") |>
          select(- c("X55.years.and.over" , "X65.years.and.over", "X85.years.and.over", 
                     "Total.Population...All.Age.Groups...100..data",
                     "X0.to.04.years", "X05.to.09.years", "X10.to.14.years", "NeighbourhoodID"))|>
          pivot_longer(2:19, names_to = "age", values_to = "pop_age_NBHD") |> 
          mutate(age_gp = case_when(age == "X0.to.14.years" ~ '19-',
                                    age == "X15.to.19.years" ~ '19-',
                                    age == "X20.to.24.years" ~ '20-29',
                                    age == "X25.to.29.years" ~ '20-29',
                                    age == "X30.to.34.years" ~ '30-39',
                                    age == "X35.to.39.years" ~ '30-39',
                                    age == "X40.to.44.years" ~ '40-49',
                                    age == "X50.to.54.years" ~ '50-59',
                                    age == "X55.to.59.years" ~ '50-59',
                                    age == "X60.to.64.years" ~ '60-69',
                                    age == "X65.to.69.years" ~ '60-69',
                                    age == "X70.to.74.years" ~ '70-79',
                                    age == "X75.to.79.years" ~ '70-79',
                                    age == "X80.to.84.years" ~ '80-89',
                                    age == "X85.to.89.years" ~ '80-89',
                                    age == "X90.to.94.years" ~ '90+',
                                    age == "X95.to.99.years" ~ '90+',
                                    age == "X100.years.and.over" ~ '90+'),
                 plus70_fc = case_when(age_gp %in% age70plus ~ 'over 70', TRUE ~ 'less than 70')) |>
             select(- age) |>
             drop_na()|>
             rename(NBHD = "Neighbourhood") |>
             group_by(NBHD, age_gp)|>
             mutate(pop_age_NBHD = sum(pop_age_NBHD),
                    NBHD = case_when(NBHD == "Danforth East York" ~ 'Danforth-East York',
                                     NBHD == "Briar Hill-Belgravia" ~ 'Briar Hill - Belgravia',
                                     TRUE ~ as.character(NBHD))) |>
             ungroup() |>
             distinct()
covid_df <- left_join(covid_df, pop_df, by = c('NBHD', 'age_gp')) |>
            group_by(district) |> 
            mutate(pop_district = sum(pop_age_NBHD), 
                   prop70plus = mean(plus70_fc == "over 70"),
                   pop_per_hospital = pop_district/num_of_hospitals) |> 
            ungroup() |>
            mutate(hospitalized_fc = case_when(hospitalized == "Yes" ~ 1, hospitalized == "No" ~ 0))
```

## b) Exploratory data analysis (EDA) 

```{r echo=FALSE}
covid_df |> group_by(district, age_gp) |>
            mutate(mu = sum(deaths)/n()) |> 
            select(district, mu) |>
            distinct() |>
            ggplot(aes(y=mu, x=age_gp)) + 
                   geom_bar(position="dodge", stat="identity") +
                   facet_wrap(~district)+
                   theme_minimal()
covid_df |> group_by(gender_fc, outcome) |>
            mutate(sum_deaths = n()) |> 
            ggplot(aes(y=sum_deaths, x=gender_fc)) + 
                   geom_bar(position="dodge", stat="identity") +
                   facet_wrap(~outcome)+
                   theme_minimal()
```

# Methods

There are two levels. Let i = 1, 2, ..., N denote individuals and j = 1, 2, 3, 4 districts. Deaths in district j follow a Poisson distribution,

\begin{centering}
    $y_{i} | \pi_{i} \sim \operatorname{Bern}\left(\pi_{i}\right)$ \\
\end{centering}

\begin{centering}
    $\eta_{i} = \beta_0+\beta_1 \text{ hospitalized}_{i} + \beta_2 \text{ sex}_{i} + \alpha_{j[i]}^{\text{age}}+\alpha_{k[i]}^{\text{district}}$ \\
\end{centering}

\begin{centering}
    $\pi_i = \operatorname{logit}^{-1}\left(\eta_{i}\right) = \frac{e^{\eta_i}}{1 + e^{\eta_i}}$ \\
\end{centering}

\begin{centering}
    $\alpha_{j}^{\text{age}} \sim \text{N}\left(\alpha_{j-1}^{\text{age}}, \sigma_{\text{age}}^{2}\right), \text { for } j=2, \ldots, 9$ \\
\end{centering}

\begin{centering}
    $\alpha_{k}^{\text{district}} \sim \text{N}\left(0, \sigma_{\text{district}}^{2}\right), \text { for } k = 1, \ldots, 4$ \\
\end{centering}

where $y_i = 1$ if the $i^{th}$ patient died due to COVID-19 and 0 otherwise, and the $\text{ hospitalized}_{i}$ and $\text{ sex}_{i}$ are indicator variables. 

```{r echo=FALSE}
covid2020 <- covid_df |> filter(year == 2020)
```

```{r echo=FALSE}
stan_df2020 <- list(N = nrow(covid2020),
                    D = length(unique(covid2020$district)),
                    A = length(unique(covid2020$age_gp)),
                    K = 3,
                    hospitalized = covid2020$hospitalized_fc,
                    sex = covid2020$gender_fc,
                    age = covid2020$age_fc,
                    district = covid2020$district_fc,
                    y = covid2020$deaths)
```

```{r echo=FALSE}
mod1 <- stan(data = stan_df2020, file = here("C:/GitHub/STA2201-W2023/Project/code/hierarchical_covid.stan"),
             chain = 1, iter = 500)
summary(mod1)[["summary"]][c(paste0("beta[",1:3, "]"), paste0("alpha_age[",1:9, "]"), paste0("alpha_district[",1:4, "]")),]
```

```{r}
alpha_district <- rstan::extract(mod1)[["alpha_district"]] |> as.data.frame() |> 
                  rename("North York" = V1, "Toronto and East York" = V2, "Scarborough" = V3, "Etobicoke York" = V4) |>
                  melt() |>
                  rename(district = variable)
alpha_district |> ggplot(aes(x = district, y = value, fill=district)) + 
                    geom_boxplot() + 
                    labs(title = "Estimated age effects by age group",
                         x = "Age groups",
                         y = expression(alpha[age]),
                         fill = "Age groups") +
                    theme_minimal()
```

```{r}
alpha_age <- rstan::extract(mod1)[["alpha_age"]] |> as.data.frame() |> 
                  melt() |>
                  rename(age = variable)
alpha_age |> ggplot(aes(x = age, y = value, fill=age)) + 
                    geom_boxplot() + 
                    labs(title = "Estimated age effects by age group",
                         x = "Age groups",
                         y = expression(alpha[age]),
                         fill = "Age groups") +
                    theme_minimal()
```

```{r echo=FALSE}
p_hat <- function(y){
  exp(y)/(1 + exp(y))
}
```

```{r}
mu <- rstan::extract(mod1)[["mu"]] |> as.data.frame()
```

# Results

# Discussion

# References


